services:
  # 1. The Backend (Node/Express)
  - type: web
    name: workspace-backend
    runtime: node
    plan: free 
    rootDir: .
    # Build from root to ensure all workspace dependencies are installed
    buildCommand: npm install && npm run build:backend
    startCommand: npm --workspace @workspace/backend start
    envVars:
      - key: NODE_ENV
        value: production
      - key: FRONTEND_ORIGIN
        value: "*" # Update this to your real frontend URL after first deploy
      - key: REDIS_URL
        fromService:
          type: redis
          name: workspace-redis
          property: connectionString

  # 2. The Frontend (React/Vite) -> CHANGED SECTION
  - type: web
    name: workspace-frontend
    env: static # This tells Render it's a Static Site
    rootDir: .
    # Build from root to ensure all workspace dependencies are installed
    buildCommand: npm install && npm run build:frontend
    staticPublishPath: ./apps/frontend/dist # Where Vite outputs the files
    envVars:
      - key: VITE_BACKEND_URL
        fromService:
          type: web
          name: workspace-backend
          property: url

  # 3. Redis (The "Memory")
  - type: redis
    name: workspace-redis
    region: singapore # or oregon, frankfurt, etc.
    plan: free
    maxMemoryPolicy: allkeys-lru
    ipAllowList: []
